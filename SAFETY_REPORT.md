# ç³»ç»Ÿå®‰å…¨æ€§åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æŠ¥å‘Šåˆ†æ R2-700 åº•ç›˜æ§åˆ¶ç³»ç»Ÿçš„å®‰å…¨æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯æ‰‹æŸ„æ–­å¼€æ—¶çš„å®‰å…¨ä¿æŠ¤ã€‚

---

## âœ… å®‰å…¨æœºåˆ¶åˆ†æ

### 1. **æ‰‹æŸ„æ–­å¼€å®‰å…¨ä¿æŠ¤ï¼ˆå·²å®ç°ï¼‰**

#### 1.1 æ‰‹æŸ„é©±åŠ¨èŠ‚ç‚¹ (joystick_node.py)

**å®‰å…¨æœºåˆ¶ï¼š**

```python
# Line 87-93: é‡ç½®åˆ°å®‰å…¨çŠ¶æ€
def _reset_states(self):
    """Reset all button and axis states to default (safe) values"""
    for btn in self.button_states:
        self.button_states[btn] = False
    for axis in self.axis_states:
        self.axis_states[axis] = 0  # âœ… æ‰€æœ‰è½´å½’é›¶
    self.get_logger().info("Joystick states reset to safety (all zeros)")
```

**è§¦å‘æ¡ä»¶ï¼š**

1. **è®¾å¤‡æ–­å¼€æ—¶ï¼š** (Line 189-196)
```python
except OSError as e:
    self.get_logger().error(f"Joystick OSError: {e}. Device may be disconnected.")
    if self.gamepad:
        self.gamepad.close()
        self.gamepad = None
    # âœ… ç«‹å³é‡ç½®åˆ°å®‰å…¨çŠ¶æ€
    self._reset_states()
    time.sleep(2)
```

2. **èŠ‚ç‚¹é”€æ¯æ—¶ï¼š** (Line 234-243)
```python
def destroy_node(self):
    """Clean up resources"""
    self.running = False
    if hasattr(self, 'publish_timer'):
        self.publish_timer.cancel()
    if self.gamepad:
        self.gamepad.close()
    # âœ… å…³é—­æ—¶é‡ç½®åˆ°å®‰å…¨çŠ¶æ€
    self._reset_states()
    super().destroy_node()
```

**å®‰å…¨æ•ˆæœï¼š**
- âœ… æ‰‹æŸ„æ–­å¼€ â†’ æ‰€æœ‰è½´å’ŒæŒ‰é’®å½’é›¶
- âœ… æŒç»­ä»¥ 20Hz å‘å¸ƒé›¶å€¼ (Line 85: timer 0.05s)
- âœ… åº•ç›˜æ”¶åˆ°çš„æŒ‡ä»¤ = `[0, 0, 0, 0, ...]`
- âœ… **æœºå™¨äººä¼šç«‹å³åœæ­¢**

---

#### 1.2 æ‰‹æŸ„æ¡¥æ¥èŠ‚ç‚¹ (joystick_bridge.py)

**å®‰å…¨æœºåˆ¶ï¼š**

```python
# Line 125-133: èŠ‚ç‚¹é”€æ¯æ—¶å‘é€åœæ­¢æŒ‡ä»¤
def destroy_node(self):
    """èŠ‚ç‚¹é”€æ¯æ—¶çš„å®‰å…¨å¤„ç†"""
    # âœ… å‘é€åœæ­¢æŒ‡ä»¤
    stop_msg = Float32MultiArray()
    stop_msg.data = [0.0, 0.0, 0.0]  # [æ–¹å‘, é€Ÿåº¦, æ—‹è½¬] å…¨éƒ¨å½’é›¶
    self.nav_pub.publish(stop_msg)
    
    self.get_logger().info("Joystick bridge stopped - sent stop command")
    super().destroy_node()
```

**å®‰å…¨æ•ˆæœï¼š**
- âœ… å³ä½¿æ‰‹æŸ„èŠ‚ç‚¹å´©æºƒï¼Œæ¡¥æ¥èŠ‚ç‚¹å…³é—­æ—¶ä¹Ÿä¼šå‘é€åœæ­¢æŒ‡ä»¤
- âœ… åŒé‡ä¿æŠ¤

---

### 2. **æ­»åŒºè¿‡æ»¤ï¼ˆé˜²æ­¢å¾®å°æ¼‚ç§»ï¼‰**

#### 2.1 æ‰‹æŸ„é©±åŠ¨èŠ‚ç‚¹

```python
# Line 50-51: æ­»åŒºé˜ˆå€¼
self.deadzone = 410  # ~5% of 8192

# Line 112-114: åº”ç”¨æ­»åŒº
if abs(normalized) < self.deadzone:
    return 0  # âœ… å°äºæ­»åŒºçš„å€¼å½“ä½œ 0
```

#### 2.2 æ‰‹æŸ„æ¡¥æ¥èŠ‚ç‚¹

```python
# Line 46: æ­»åŒºå‚æ•°
self.declare_parameter('deadzone', 410)

# Line 85-91: åº”ç”¨æ­»åŒº
if abs(lx) < self.deadzone:
    lx = 0
if abs(ly) < self.deadzone:
    ly = 0
if abs(rx) < self.deadzone:
    rx = 0
```

**å®‰å…¨æ•ˆæœï¼š**
- âœ… æ‘‡æ†å›ä¸­æ—¶çš„å¾®å°æ¼‚ç§»è¢«è¿‡æ»¤
- âœ… é˜²æ­¢æœºå™¨äººåœ¨æ— æ“ä½œæ—¶å¾®åŠ¨
- âœ… åŒå±‚æ­»åŒºè¿‡æ»¤ï¼ˆæ‰‹æŸ„é©±åŠ¨ + æ¡¥æ¥èŠ‚ç‚¹ï¼‰

---

### 3. **æ•°æ®å½’ä¸€åŒ–å’Œé™å¹…**

#### 3.1 æ‰‹æŸ„é©±åŠ¨èŠ‚ç‚¹

```python
# Line 95-116: å½’ä¸€åŒ–åˆ° -8192 ~ 8192
def _normalize_axis(self, axis_name, raw_value):
    # ... å½’ä¸€åŒ–é€»è¾‘
    normalized = int((raw_value - mid) / range_half * 8192)
    
    # âœ… åº”ç”¨æ­»åŒº
    if abs(normalized) < self.deadzone:
        return 0
    
    return normalized  # âœ… ä¿è¯è¾“å‡ºåœ¨åˆç†èŒƒå›´å†…
```

#### 3.2 æ‰‹æŸ„æ¡¥æ¥èŠ‚ç‚¹

```python
# Line 104-105: é€Ÿåº¦é™å¹…
magnitude = math.sqrt(lx*lx + ly*ly) / 8192.0  # âœ… å½’ä¸€åŒ–åˆ° 0-1
speed_cm = magnitude * self.max_speed_cm  # âœ… é™åˆ¶æœ€å¤§é€Ÿåº¦

# Line 108: æ—‹è½¬é™å¹…
rotation = (rx / 8192.0) * self.max_rotation  # âœ… é™åˆ¶æœ€å¤§æ—‹è½¬é€Ÿåº¦
```

**å®‰å…¨æ•ˆæœï¼š**
- âœ… é€Ÿåº¦ä¸ä¼šè¶…è¿‡ `max_speed_cm` (é»˜è®¤ 100 cm/s)
- âœ… æ—‹è½¬é€Ÿåº¦ä¸ä¼šè¶…è¿‡ `max_rotation` (é»˜è®¤ 2.0 rad/s)
- âœ… é˜²æ­¢æ‰‹æŸ„å¼‚å¸¸å€¼å¯¼è‡´æœºå™¨äººæš´èµ°

---

## ğŸ” æ‰‹æŸ„æ–­å¼€åœºæ™¯æµ‹è¯•

### åœºæ™¯ 1ï¼šæ‰‹æŸ„ç‰©ç†æ–­å¼€ï¼ˆè“ç‰™æ–­å¼€/ç”µé‡è€—å°½ï¼‰

**äº‹ä»¶æµç¨‹ï¼š**
```
1. æ‰‹æŸ„è“ç‰™æ–­å¼€
   â†“
2. evdev è¯»å–å¤±è´¥ â†’ OSError
   â†“
3. joystick_node æ•è·å¼‚å¸¸ (line 189)
   â†“
4. è°ƒç”¨ _reset_states() â†’ æ‰€æœ‰è½´å½’é›¶
   â†“
5. æŒç»­å‘å¸ƒé›¶å€¼ (20Hz)
   â†“
6. joystick_bridge æ”¶åˆ° [0, 0, 0, ...]
   â†“
7. è½¬æ¢ä¸º [0.0, 0.0, 0.0] å‘å¸ƒåˆ° /local_driving
   â†“
8. local_navigation_node æ”¶åˆ°åœæ­¢æŒ‡ä»¤
   â†“
9. å‘é€ [0, 0, 0, 0] åˆ°ç”µæœº
   â†“
10. æœºå™¨äººåœæ­¢ âœ…
```

**å“åº”æ—¶é—´ï¼š**
- æ‰‹æŸ„æ–­å¼€ â†’ å¼‚å¸¸æ•è·ï¼š< 100ms
- é‡ç½®çŠ¶æ€ â†’ å‘å¸ƒé›¶å€¼ï¼š< 50ms (20Hz å®šæ—¶å™¨)
- æ€»å“åº”æ—¶é—´ï¼š**< 150ms**

---

### åœºæ™¯ 2ï¼šæ‰‹æŸ„èŠ‚ç‚¹å´©æºƒ

**äº‹ä»¶æµç¨‹ï¼š**
```
1. joystick_node è¿›ç¨‹å´©æºƒ
   â†“
2. destroy_node() è¢«è°ƒç”¨ (line 234)
   â†“
3. _reset_states() â†’ æ‰€æœ‰è½´å½’é›¶
   â†“
4. ä½†æ˜¯èŠ‚ç‚¹å·²åœæ­¢ï¼Œä¸å†å‘å¸ƒæ•°æ®
   â†“
5. joystick_bridge ä¸å†æ”¶åˆ°æ–°æ¶ˆæ¯
   â†“
6. joystick_bridge ä¿æŒæœ€åä¸€æ¡æ¶ˆæ¯
   â†“
7. âš ï¸ æ½œåœ¨é—®é¢˜ï¼šå¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯ä¸æ˜¯é›¶ï¼Œä¼šä¿æŒè¯¥çŠ¶æ€
```

**é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š**

âŒ **å½“å‰é—®é¢˜ï¼š** å¦‚æœæ‰‹æŸ„èŠ‚ç‚¹å´©æºƒï¼Œjoystick_bridge ä¸ä¼šè‡ªåŠ¨å‘é€åœæ­¢æŒ‡ä»¤

âœ… **å·²æœ‰çš„éƒ¨åˆ†ä¿æŠ¤ï¼š** joystick_bridge çš„ destroy_node() ä¼šå‘é€åœæ­¢æŒ‡ä»¤ (line 128)

âš ï¸ **å»ºè®®æ”¹è¿›ï¼š** æ·»åŠ è¶…æ—¶æ£€æµ‹

---

### åœºæ™¯ 3ï¼šæ‰‹æŸ„æ¡¥æ¥èŠ‚ç‚¹å´©æºƒ

**äº‹ä»¶æµç¨‹ï¼š**
```
1. joystick_bridge è¿›ç¨‹å´©æºƒ
   â†“
2. destroy_node() è¢«è°ƒç”¨ (line 125)
   â†“
3. å‘é€åœæ­¢æŒ‡ä»¤ [0.0, 0.0, 0.0]
   â†“
4. local_navigation_node æ”¶åˆ°åœæ­¢æŒ‡ä»¤
   â†“
5. æœºå™¨äººåœæ­¢ âœ…
```

**å®‰å…¨æ•ˆæœï¼š**
- âœ… èŠ‚ç‚¹å´©æºƒæ—¶ä¼šå‘é€åœæ­¢æŒ‡ä»¤
- âœ… æœºå™¨äººä¼šåœæ­¢

---

## ğŸ“Š å®‰å…¨æœºåˆ¶æ€»ç»“è¡¨

| å®‰å…¨æœºåˆ¶ | å®ç°ä½ç½® | è§¦å‘æ¡ä»¶ | å“åº”æ—¶é—´ | çŠ¶æ€ |
|---------|---------|---------|---------|------|
| æ‰‹æŸ„æ–­å¼€è‡ªåŠ¨å½’é›¶ | joystick_node.py:189-196 | è®¾å¤‡æ–­å¼€/OSError | < 150ms | âœ… å·²å®ç° |
| èŠ‚ç‚¹é”€æ¯æ—¶å½’é›¶ | joystick_node.py:234-243 | èŠ‚ç‚¹å…³é—­/Ctrl+C | < 50ms | âœ… å·²å®ç° |
| æ¡¥æ¥èŠ‚ç‚¹åœæ­¢æŒ‡ä»¤ | joystick_bridge.py:125-133 | èŠ‚ç‚¹å…³é—­ | < 50ms | âœ… å·²å®ç° |
| æ­»åŒºè¿‡æ»¤ï¼ˆåŒå±‚ï¼‰ | joystick_node + bridge | æ‘‡æ†å›ä¸­ | å®æ—¶ | âœ… å·²å®ç° |
| é€Ÿåº¦é™å¹… | joystick_bridge.py:104-108 | æ¯æ¬¡è½¬æ¢ | å®æ—¶ | âœ… å·²å®ç° |
| è¯é¢˜è¶…æ—¶æ£€æµ‹ | - | æ¶ˆæ¯ä¸¢å¤± | - | âš ï¸ å»ºè®®æ·»åŠ  |

---

## âš ï¸ å»ºè®®æ”¹è¿›

### 1. æ·»åŠ è¯é¢˜è¶…æ—¶æ£€æµ‹ï¼ˆæ¨èï¼‰

**é—®é¢˜ï¼š** å¦‚æœ joystick_node å´©æºƒä½† joystick_bridge ä»åœ¨è¿è¡Œï¼Œå¯èƒ½ä¿æŒæœ€åçš„éé›¶æŒ‡ä»¤

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨ joystick_bridge ä¸­æ·»åŠ è¶…æ—¶æ£€æµ‹

```python
# ä¼ªä»£ç ç¤ºä¾‹
class JoystickBridge(Node):
    def __init__(self):
        # ...
        self.last_msg_time = self.get_clock().now()
        self.timeout_threshold = 0.5  # 500ms è¶…æ—¶
        
        # æ·»åŠ çœ‹é—¨ç‹—å®šæ—¶å™¨
        self.watchdog_timer = self.create_timer(0.1, self.check_timeout)
    
    def joystick_callback(self, msg):
        self.last_msg_time = self.get_clock().now()
        # ... åŸæœ‰é€»è¾‘
    
    def check_timeout(self):
        time_since_last = (self.get_clock().now() - self.last_msg_time).nanoseconds / 1e9
        if time_since_last > self.timeout_threshold:
            # å‘é€åœæ­¢æŒ‡ä»¤
            stop_msg = Float32MultiArray()
            stop_msg.data = [0.0, 0.0, 0.0]
            self.nav_pub.publish(stop_msg)
            self.get_logger().warn("Joystick timeout - sending stop command")
```

### 2. æ·»åŠ å¿ƒè·³æœºåˆ¶ï¼ˆå¯é€‰ï¼‰

**ç›®çš„ï¼š** ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨æ­£å¸¸è¿è¡Œ

**å®ç°ï¼š** ä½¿ç”¨ ROS2 çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æˆ–è‡ªå®šä¹‰å¿ƒè·³è¯é¢˜

---

## ğŸ¯ å½“å‰å®‰å…¨æ€§è¯„ä¼°

### âœ… ä¼˜ç‚¹

1. **æ‰‹æŸ„æ–­å¼€ä¿æŠ¤å®Œå–„**
   - è®¾å¤‡æ–­å¼€æ—¶ç«‹å³å½’é›¶
   - æŒç»­å‘å¸ƒé›¶å€¼
   - å“åº”é€Ÿåº¦å¿« (< 150ms)

2. **æ­»åŒºè¿‡æ»¤æœ‰æ•ˆ**
   - åŒå±‚æ­»åŒºï¼ˆæ‰‹æŸ„ + æ¡¥æ¥ï¼‰
   - é˜²æ­¢å¾®å°æ¼‚ç§»

3. **é€Ÿåº¦é™å¹…**
   - æœ€å¤§é€Ÿåº¦å¯é…ç½®
   - é˜²æ­¢æ‰‹æŸ„å¼‚å¸¸å¯¼è‡´æš´èµ°

4. **èŠ‚ç‚¹é”€æ¯æ—¶çš„å®‰å…¨å¤„ç†**
   - æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ destroy_node() å¤„ç†
   - å‘é€åœæ­¢æŒ‡ä»¤

### âš ï¸ éœ€è¦æ³¨æ„çš„æƒ…å†µ

1. **æ‰‹æŸ„èŠ‚ç‚¹å´©æºƒä½†æ¡¥æ¥èŠ‚ç‚¹ç»§ç»­è¿è¡Œ**
   - å½“å‰æ²¡æœ‰è¶…æ—¶æ£€æµ‹
   - å¯èƒ½ä¿æŒæœ€åçš„éé›¶æŒ‡ä»¤
   - **å»ºè®®æ·»åŠ è¶…æ—¶æ£€æµ‹**

2. **ç½‘ç»œå»¶è¿Ÿï¼ˆå¦‚æœä½¿ç”¨è¿œç¨‹æ§åˆ¶ï¼‰**
   - å½“å‰æ²¡æœ‰å»¶è¿Ÿè¡¥å¿
   - å¦‚æœé€šè¿‡ç½‘ç»œæ§åˆ¶ï¼Œå»ºè®®æ·»åŠ å»¶è¿Ÿæ£€æµ‹

---

## ğŸ“ ç»“è®º

### æ‰‹æŸ„æ–­å¼€æ—¶çš„è¡Œä¸ºï¼š

âœ… **æ­£å¸¸æ–­å¼€ï¼ˆè“ç‰™æ–­å¼€ï¼‰ï¼š**
- æ‰€æœ‰è½´ç«‹å³å½’é›¶
- æŒç»­å‘å¸ƒé›¶å€¼
- æœºå™¨äººåœæ­¢
- **æœºå™¨äººä¸ä¼šæš´èµ°**

âœ… **èŠ‚ç‚¹å´©æºƒï¼ˆCtrl+Cï¼‰ï¼š**
- å‘é€åœæ­¢æŒ‡ä»¤
- æœºå™¨äººåœæ­¢
- **æœºå™¨äººä¸ä¼šæš´èµ°**

âš ï¸ **æç«¯æƒ…å†µï¼ˆèŠ‚ç‚¹å´©æºƒä½†æœªè°ƒç”¨ destroyï¼‰ï¼š**
- å¯èƒ½ä¿æŒæœ€åæŒ‡ä»¤
- å»ºè®®æ·»åŠ è¶…æ—¶æ£€æµ‹

### æ€»ä½“è¯„ä¼°ï¼š

- âœ… å®‰å…¨æœºåˆ¶**å·²åŸºæœ¬å®Œå–„**
- âœ… å¤§éƒ¨åˆ†æ–­å¼€åœºæ™¯éƒ½æœ‰ä¿æŠ¤
- âš ï¸ å»ºè®®æ·»åŠ è¶…æ—¶æ£€æµ‹ä½œä¸ºé¢å¤–ä¿é™©
- âœ… ç¬¦åˆæœºå™¨äººå®‰å…¨è®¾è®¡åŸåˆ™

---

## ğŸ“š ç›¸å…³ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|-----|------|------|
| æ‰‹æŸ„æ–­å¼€å¤„ç† | joystick_node.py | 189-196 |
| çŠ¶æ€å½’é›¶å‡½æ•° | joystick_node.py | 87-93 |
| èŠ‚ç‚¹é”€æ¯å¤„ç†ï¼ˆæ‰‹æŸ„ï¼‰ | joystick_node.py | 234-243 |
| èŠ‚ç‚¹é”€æ¯å¤„ç†ï¼ˆæ¡¥æ¥ï¼‰ | joystick_bridge.py | 125-133 |
| æ­»åŒºè¿‡æ»¤ï¼ˆæ‰‹æŸ„ï¼‰ | joystick_node.py | 112-114 |
| æ­»åŒºè¿‡æ»¤ï¼ˆæ¡¥æ¥ï¼‰ | joystick_bridge.py | 85-91 |
| é€Ÿåº¦é™å¹… | joystick_bridge.py | 104-108 |

---

**æŠ¥å‘Šæ—¥æœŸï¼š** 2026-02-02  
**ç³»ç»Ÿç‰ˆæœ¬ï¼š** R2-700 å…¨å‘è½®åº•ç›˜æ§åˆ¶ç³»ç»Ÿ  
**å®‰å…¨ç­‰çº§ï¼š** âœ… è‰¯å¥½ï¼ˆå»ºè®®æ·»åŠ è¶…æ—¶æ£€æµ‹è¿›ä¸€æ­¥æå‡ï¼‰
